import React, { useRef, useState } from 'react'
import PropTypes from 'prop-types'
import defaultImg from '../../assets/img/default.png'
import { connect } from 'react-redux'
import { Link } from 'react-router-dom'
import userNameHandler from '../../utils/userNameHandler'
import textCheck from '../../utils/textCheck'
import sinceDate from '../../utils/sinceDate'
import { deleteComment, addCommentLike, addCommentDislike } from '../../actions/post'

const Comment = ({ auth, deleteComment, addCommentLike, addCommentDislike, postOwner, comment: { _id, postId, text, likes, dislikes, name, avatar, user, date } }) => {
    const [readMore, setReadMore] = useState({
        type: '',
        commentId: ''
    })
    const [dropDown, setDropDown] = useState({
        type: '',
        commentId: ''
    })
    let likedComment = likes && likes.filter(like=> like.user === auth.user._id).length > 0
    let dislikedComment = dislikes && dislikes.filter(dislike=> dislike.user === auth.user._id).length > 0
    const filledLike = 'M295.706,35.522C295.706,35.522,295.706,35.522,295.706,35.522c-34.43-0.184-67.161,14.937-89.339,41.273c-22.039-26.516-54.861-41.68-89.339-41.273C52.395,35.522,0,87.917,0,152.55C0,263.31,193.306,371.456,201.143,375.636c3.162,2.113,7.286,2.113,10.449,0c7.837-4.18,201.143-110.759,201.143-223.086C412.735,87.917,360.339,35.522,295.706,35.522zM206.367,354.738C176.065,336.975,20.898,242.412,20.898,245.738z'
    const unfilledLike = 'M295.706,35.522C295.706,35.522,295.706,35.522,295.706,35.522c-34.43-0.184-67.161,14.937-89.339,41.273c-22.039-26.516-54.861-41.68-89.339-41.273C52.395,35.522,0,87.917,0,152.55C0,263.31,193.306,371.456,201.143,375.636c3.162,2.113,7.286,2.113,10.449,0c7.837-4.18,201.143-110.759,201.143-223.086C412.735,87.917,360.339,35.522,295.706,35.522zM206.367,354.738C176.065,336.975,20.898,242.412,20.898,152.55c0-53.091,43.039-96.131,96.131-96.131c32.512-0.427,62.938,15.972,80.457,43.363c3.557,4.905,10.418,5.998,15.323,2.44c0.937-0.68,1.761-1.503,2.44-2.44c29.055-44.435,88.631-56.903,133.066-27.848c27.202,17.787,43.575,48.114,43.521,80.615C391.837,243.456,236.669,337.497,206.367,354.738z'
    // handlers
    let dropdownRef = useRef()
    let handleDropDown = (id, type) =>{
        dropdownRef.current.style.zIndex = "100"
        if(type==='dpMenu'){
            id === dropDown.commentId && dropDown.type ? setDropDown({ type: '', commentId: id }) : setDropDown({ type: 'dpMenu', commentId: id })
        }else{
            id === readMore.commentId && readMore.type ? setReadMore({ type: '', commentId: id }) : setReadMore({ type: 'readMore', commentId: id })
        }
        return dropdownRef.current
    }
    return (
        <div className="comments-card">
            <div ref={dropdownRef} className="dropdown">
                <span onClick={()=>handleDropDown(_id, 'dpMenu')} className="svg-icon toggler">
                    <svg viewBox="0 0 512 512">
                        <g>
                            <g>
                                <path d="M64,192c-35.285,0-64,28.715-64,64s28.715,64,64,64s64-28.715,64-64S99.285,192,64,192z M64,298.667
                                    c-23.531,0-42.667-19.136-42.667-42.667S40.469,213.333,64,213.333c23.531,0,42.667,19.136,42.667,42.667
                                    S87.531,298.667,64,298.667z"/>
                            </g>
                        </g>
                        <g>
                            <g>
                                <path d="M256,192c-35.285,0-64,28.715-64,64s28.715,64,64,64s64-28.715,64-64S291.285,192,256,192z M256,298.667
                                    c-23.531,0-42.667-19.136-42.667-42.667s19.136-42.667,42.667-42.667s42.667,19.136,42.667,42.667S279.531,298.667,256,298.667z"
                                    />
                            </g>
                        </g>
                        <g>
                            <g>
                                <path d="M448,192c-35.285,0-64,28.715-64,64s28.715,64,64,64c35.285,0,64-28.715,64-64S483.285,192,448,192z M448,298.667
                                    c-23.531,0-42.667-19.136-42.667-42.667s19.136-42.667,42.667-42.667c23.531,0,42.667,19.136,42.667,42.667
                                    S471.531,298.667,448,298.667z"/>
                            </g>
                        </g>
                    </svg>
                </span>
                <ul className={dropDown.type && _id === dropDown.commentId ? "show":''}>
                        {auth.user._id !== user &&
                            auth.user._id !== postOwner  ?
                            <>
                                <li className="svg-icon">
                                    <svg viewBox="0 0 511.996 511.996"><g><g><path d="m507.243 244.504-239.751-239.751c-6.338-6.338-16.65-6.338-22.988 0l-239.751 239.751c-6.337 6.337-6.337 16.65 0 22.987l142.742 142.742c2.93 2.929 7.678 2.929 10.607 0s2.929-7.678 0-10.606l-142.742-142.742c-.489-.489-.489-1.285 0-1.774l239.751-239.751c.488-.489 1.285-.489 1.773 0l239.751 239.751c.489.489.489 1.285 0 1.774l-239.75 239.751c-.488.489-1.285.489-1.773 0l-72.763-72.762c-2.929-2.928-7.677-2.929-10.607 0-2.929 2.929-2.929 7.678 0 10.606l72.763 72.762c3.169 3.169 7.332 4.753 11.494 4.753s8.325-1.584 11.494-4.753l239.751-239.751c6.336-6.337 6.336-16.649-.001-22.987z"/><path d="m255.998 462.468c3.875 0 7.519-1.509 10.26-4.25l191.961-191.96c2.74-2.74 4.249-6.384 4.249-10.26s-1.509-7.52-4.249-10.26l-191.961-191.96c-2.741-2.741-6.385-4.25-10.26-4.25s-7.519 1.509-10.26 4.25l-191.961 191.96c-2.74 2.74-4.249 6.384-4.249 10.26s1.509 7.52 4.249 10.26l191.961 191.96c2.741 2.741 6.385 4.25 10.26 4.25zm0-397.737 191.267 191.267-191.267 191.267-191.267-191.267z"/><path d="m255.998 317.514c14.052 0 25.799-10.982 26.748-25.056l4.086-67.934c.249-4.135-2.901-7.688-7.036-7.937-4.138-.256-7.688 2.901-7.937 7.036l-4.083 67.879c-.416 6.174-5.59 11.011-11.778 11.011s-11.362-4.836-11.775-10.956l-8.044-133.764c-.375-5.548 1.51-10.84 5.307-14.903 3.798-4.063 8.951-6.3 14.513-6.3s10.715 2.237 14.513 6.3c3.797 4.063 5.682 9.355 5.304 14.958l-1.875 31.137c-.249 4.134 2.9 7.688 7.035 7.937 4.179.255 7.688-2.901 7.938-7.036l1.872-31.082c.647-9.596-2.747-19.13-9.315-26.156-6.568-7.027-15.852-11.057-25.471-11.057s-18.902 4.03-25.471 11.057c-6.568 7.026-9.963 16.56-9.318 26.101l8.044 133.764c.944 14.019 12.691 25.001 26.743 25.001z"/><path d="m284.683 361.72c0-15.817-12.868-28.685-28.685-28.685s-28.685 12.868-28.685 28.685 12.868 28.685 28.685 28.685 28.685-12.868 28.685-28.685zm-42.37 0c0-7.546 6.139-13.685 13.685-13.685s13.685 6.139 13.685 13.685-6.139 13.685-13.685 13.685-13.685-6.139-13.685-13.685z"/></g></g></svg>
                                        <p>Report comment
                                            <span>I have doubts about this comment</span>
                                        </p>
                                    </li>
                                <li className="svg-icon">
                                    <svg viewBox="0 0 490.034 490.034">
                                        <g>
                                        <g>
                                            <path d="M435.667,54.311c-7-7.1-18.4-7-25.5,0l-64,64c-79.3-36-163.9-27.2-244.6,25.5c-60.1,39.2-96.6,88.5-98.1,90.6
                                                c-4.8,6.6-4.6,15.6,0.5,22c34.2,42,70,74.7,106.6,97.5l-56.3,56.3c-7,7-7,18.4,0,25.5c3.5,3.5,8.1,5.3,12.7,5.3s9.2-1.8,12.7-5.3
                                                l356-355.9C442.667,72.811,442.667,61.411,435.667,54.311z M200.467,264.011c-2.6-5.9-3.9-12.3-3.9-19c0-12.9,5-25.1,14.2-34.3
                                                c14.4-14.4,35.7-17.8,53.3-10.3L200.467,264.011z M290.667,173.911c-32.7-21-76.8-17.2-105.3,11.3c-16,16-24.7,37.2-24.7,59.7
                                                c0,16.4,4.7,32.1,13.4,45.6l-37.1,37.1c-32.5-18.8-64.5-46.6-95.6-82.9c13.3-15.6,41.4-45.7,79.9-70.8
                                                c66.6-43.4,132.9-52.8,197.5-28.1L290.667,173.911z"/>
                                        </g>
                                        </g>
                                        <g>
                                            <g>
                                                <path d="M486.067,233.611c-24.7-30.4-50.3-56-76.3-76.3c-7.9-6.1-19.2-4.7-25.4,3.1c-6.1,7.8-4.7,19.1,3.1,25.3
                                                    c20.6,16.1,41.2,36.1,61.2,59.5c-11.8,13.8-34.8,38.6-66,61.3c-60.1,43.7-120.8,59.5-180.3,46.9c-9.7-2.1-19.3,4.2-21.3,13.9
                                                    c-2.1,9.7,4.2,19.3,13.9,21.3c15.5,3.3,31.1,4.9,46.8,4.9c23.6,0,47.4-3.7,71.1-11.1c31.1-9.7,62-25.7,91.9-47.5
                                                    c50.4-36.9,80.5-77.6,81.8-79.3C491.367,249.011,491.167,240.011,486.067,233.611z"/>
                                            </g>
                                        </g>
                                    </svg>  
                                    <p>Hide comment
                                        <span>I don't want to see it again</span>
                                    </p>
                                </li>
                            </>
                        :(
                        <>
                            <li onClick={()=>deleteComment(_id)} className="svg-icon">
                                <svg viewBox="0 0 407.521 407.521">
                                    <g>
                                        <g>
                                            <g>
                                                <path d="M335.94,114.944H71.581c-2.86-0.243-5.694,0.702-7.837,2.612c-2.107,2.024-3.083,4.954-2.612,7.837l27.167,236.669
                                                    c3.186,26.093,25.436,45.647,51.722,45.453h131.657c27.026,0.385,49.791-20.104,52.245-47.02l22.465-236.147
                                                    c0.139-2.533-0.811-5.005-2.612-6.792C341.634,115.646,338.8,114.701,335.94,114.944z M303.026,359.45
                                                    c-1.642,15.909-15.366,27.803-31.347,27.167H140.022c-15.694,0.637-29.184-11.024-30.825-26.645L83.075,135.842h241.371
                                                    L303.026,359.45z"/>
                                                <path d="M374.079,47.026H266.454V30.307c0.58-16.148-12.04-29.708-28.188-30.288c-0.53-0.019-1.061-0.024-1.591-0.014h-65.829
                                                    c-16.156-0.299-29.494,12.555-29.793,28.711c-0.01,0.53-0.005,1.061,0.014,1.591v16.718H33.442
                                                    c-5.771,0-10.449,4.678-10.449,10.449s4.678,10.449,10.449,10.449h340.637c5.771,0,10.449-4.678,10.449-10.449
                                                    S379.849,47.026,374.079,47.026z M245.556,30.307v16.718h-83.592V30.307c-0.589-4.579,2.646-8.768,7.225-9.357
                                                    c0.549-0.071,1.104-0.086,1.656-0.047h65.829c4.605-0.326,8.603,3.142,8.929,7.748C245.643,29.203,245.627,29.758,245.556,30.307
                                                    z"/>
                                            </g>
                                        </g>
                                    </g>
                                </svg>  
                                <p>Delete comment
                                    <span>Permanently delete this comment</span>
                                </p>
                            </li>
                        </>
                        )}
                </ul>
            </div>
            <div className="inner">
                <div className="head">
                    <div className="off-user">
                        <div className="avatar">
                            <Link to={`/profile/${user}`}><img src={avatar === "default"?defaultImg:avatar} alt="avatar" /></Link>
                        </div>
                        <div className="user-info">
                            <div className="inline">
                                <div className='comment'>
                                    <span className="text-bold underline"><Link to={`/profile/${user}`} title={name}>{userNameHandler(name, false)}</Link></span>
                                    <div className="body">
                                        <p>{text.length > 100 && readMore.type && _id === readMore.commentId ? (<span onClick={()=>handleDropDown(_id, 'readMore')}>{textCheck(text)}</span>) : (<span onClick={()=>handleDropDown(_id, 'readMore')}>{textCheck(text.slice(0, 100))}</span>)}{text.length > 100 && ((!readMore.type) || (_id !== readMore.commentId)) && (<span className="text-bold readMore" onClick={()=>handleDropDown(_id, 'readMore')}> ...Read more</span>)}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="footer">
                                <div className="head">
                                    <div className="like reagir">
                                        <span className="underline" style={likedComment ? {color:'var(--Primary-color)'}:{color:'var(--Grey-color)'}} onClick={()=>addCommentLike(_id)}>Well said</span>
                                        <span className="underline mlt" style={dislikedComment ? {color:'var(--Primary-color)'}:{color:'var(--Grey-color)'}} onClick={()=>addCommentDislike(_id)}>Badly said</span>
                                        <span className="date underline mlt" title={date}>{sinceDate(date)}</span>
                                    </div>
                                    {likes.length + dislikes.length !== 0 && 
                                    <span style={(dislikes.length > 0 && likes.length > 0) ?{width:'55px'}:{width:'40px'}} className="mx-1 cmntsnbr svg-icon">
                                        {likes.length > 0 &&
                                        <svg viewBox="0 0 412.735 412.735">
                                            <g>
                                                <g>
                                                    <path fill={likedComment?'var(--Danger-color)':''} d={likedComment ? filledLike : unfilledLike} />
                                                </g>
                                            </g>
                                        </svg>}
                                        {dislikes.length > 0 &&
                                        <svg id='dislike' viewBox="0 0 100 100">
                                            <path fill={dislikedComment?'var(--Dark-color)':''} d="M91.412 43.89c1.908-4.279 1.205-9.664-1.773-13.568.574-4.674-1.463-9.404-5.25-12.259-.027-4.584-2.497-7.146-7.949-8.412-2.568-.595-5.218-.885-8.104-.885-.74 0-1.51.019-2.299.059-5.161.255-9.236.457-14.781 1.34-.31.049-.659.1-1.033.155-3.37.491-8.879 1.298-12.447 4.405-.651-.856-1.847-1.847-3.964-2.086l-7.748-.724c-.743-.097-1.486-.196-2.229-.296-1.741-.232-3.54-.472-5.326-.686a10.263 10.263 0 0 0-1.216-.074c-4.325 0-7.641 2.867-8.446 7.302-1.928 10.58-1.784 21.689.426 33.019 1.02 5.235 5.039 8.619 10.239 8.619h.001c.449 0 .909-.026 1.366-.077 2.63-.29 5.258-.589 7.887-.888l4.212-.477c1.167-.132 3.12-.351 4.439-2.11.075-.1.143-.201.207-.301.395.214.8.377 1.195.477 1.153.297 1.554.701 1.818 1.097.373.559.751 1.087 1.117 1.597.238.332.476.664.713 1.007 1.962 2.828 4.402 5.19 7.461 7.218 4.605 3.052 8.002 7.443 10.471 11.005.023.11.049.25.071.363.035.182.069.361.107.54.206.959.376 1.923.504 2.868.87 6.297 5.383 9.116 9.469 9.116 1.617 0 3.255-.426 4.737-1.23 3.885-2.109 4.558-4.978 5.151-7.508.047-.201.096-.408.149-.625 1.415-5.863.203-13.564-2.879-18.314a73.585 73.585 0 0 1-1.563-2.53c.445-.094.878-.181 1.302-.259.644-.119 1.332-.192 2.06-.271 1.44-.155 3.073-.33 4.794-.907 3.541-1.188 6.175-3.515 7.418-6.553 1.14-2.802 1.029-6.01-.307-9.147z"/>
                                            <path fill={dislikedComment?'var(--Dark-color)':''} d="M85.775 32.274c2.654 2.908 3.282 7.36 1.448 10.554-.439.767-.39 1.295-.011 2.037 2.382 4.68.713 9.055-4.257 10.722-2.05.688-4.128.634-6.276 1.029-2.207.407-4.565 1.02-6.951 1.46.308.689.456 1.136.691 1.536 1.234 2.091 2.425 4.212 3.745 6.244 2.52 3.881 3.405 10.509 2.316 15.025-.637 2.632-.781 4.094-3.21 5.413-3.277 1.781-7.314.273-8.009-4.753a43.128 43.128 0 0 0-.559-3.176c-.157-.732-.241-1.56-.647-2.148-3.272-4.754-6.935-9.171-11.797-12.393-2.503-1.66-4.621-3.65-6.324-6.104-.59-.853-1.212-1.681-1.787-2.542-1.033-1.549-2.504-2.384-4.277-2.841-.388-.098-.918-.562-.97-.919-.567-3.821-1.25-7.636-1.512-11.479-.449-6.589-.301-14.218 1.507-19.607 1.592-4.747 9.522-5.438 13.027-5.997 5.321-.847 9.228-1.04 14.334-1.293 3.099-.154 6.15.008 9.232.723 4.472 1.038 5.004 2.465 4.582 5.83.044.436.436.991.827 1.213 3.372 1.923 5.257 5.967 4.418 9.789-.157.706-.024 1.147.46 1.677z"/>
                                            <path fill={dislikedComment?'var(--Dark-color)':''} d="M33.339 16.834l-7.746-.723c-2.528-.331-5.055-.683-7.588-.985-2.658-.319-4.521 1.121-5.006 3.794-1.915 10.512-1.624 20.997.417 31.455.697 3.579 3.398 5.553 6.998 5.153 4.031-.446 8.06-.91 12.09-1.364 1.727-.195 1.834-.312 1.541-2.004-1.952-11.285-2.365-22.55.456-33.771.261-1.041-.136-1.44-1.162-1.555zm-8.035 33.545a2.85 2.85 0 0 1-.122-5.698 2.85 2.85 0 1 1 .122 5.698z"/>
                                        </svg>}
                                        {likes.length + dislikes.length}
                                    </span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    )
}

Comment.propTypes = {
    auth: PropTypes.object.isRequired,
    deleteComment: PropTypes.func.isRequired,
    comment: PropTypes.object.isRequired,
    post_id: PropTypes.string.isRequired,
    addCommentLike: PropTypes.func.isRequired,
    addCommentDislike: PropTypes.func.isRequired
}

const mapStateToProps = state => ({
    auth: state.auth
})

export default connect(mapStateToProps,{ deleteComment, addCommentLike, addCommentDislike })(Comment)